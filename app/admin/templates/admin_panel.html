{% extends "base.html" %}
{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="admin-page mx-auto max-w-[1100px] p-6 text-copy">
  <h1 class="text-2xl font-bold mb-6">Admin Panel</h1>

  <!-- Hub cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
    <a href="{{ url_for('admin.actions', week=selected_week) }}"
       class="block rounded-2xl border border-border bg-foreground p-5 hover:ring-2 hover:ring-primary/40">
      <div class="text-lg font-semibold mb-1">Admin Actions</div>
      <p class="text-sm text-copy-lighter">Import lines/scores, lock weeks, finalize ATS.</p>
    </a>

    <a href="{{ url_for('admin.picks_matrix', week=selected_week) }}"
       class="block rounded-2xl border border-border bg-foreground p-5 hover:ring-2 hover:ring-primary/40">
      <div class="text-lg font-semibold mb-1">Picks Matrix</div>
      <p class="text-sm text-copy-lighter">All users’ picks for a week.</p>
    </a>

    <a href="{{ url_for('admin.ats_summary', week=selected_week) }}"
       class="block rounded-2xl border border-border bg-foreground p-5 hover:ring-2 hover:ring-primary/40">
      <div class="text-lg font-semibold mb-1">ATS Summary</div>
      <p class="text-sm text-copy-lighter">Covers / Pushes / No-covers by team.</p>
    </a>

    <a href="{{ url_for('admin.db_home') }}"
       class="block rounded-2xl border border-border bg-foreground p-5 hover:ring-2 hover:ring-primary/40">
      <div class="text-lg font-semibold mb-1">DB Management</div>
      <p class="text-sm text-copy-lighter">Browse tables and edit cells inline.</p>
    </a>
  </div>

  <!-- Weekly Lines preview on hub -->
  <div class="rounded-xl border border-border bg-foreground p-4" id="lines">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">Weekly Lines (Admin Preview)</h2>
      <span id="admin-lines-status" class="text-copy-light text-sm"></span>
    </div>

    <form id="admin-lines-form" class="mb-3 flex items-center gap-2">
      <label class="flex items-center gap-2">
        <span class="text-copy-light">Week:</span>
        <select id="admin-lines-week" name="week" class="border border-border rounded px-2 py-1 bg-foreground text-copy">
          {% for w in weeks %}
            <option value="{{ w }}" {{ 'selected' if w == selected_week else '' }}>{{ w }}</option>
          {% endfor %}
        </select>
      </label>
    </form>

    <div id="admin-lines"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
  (function() {
    const container = document.getElementById('admin-lines');
    const weekSel   = document.getElementById('admin-lines-week');
    const statusEl  = document.getElementById('admin-lines-status');
    const userTZ    = Intl.DateTimeFormat().resolvedOptions().timeZone || '';

    async function loadAdminLines(w) {
      if (!container) return;
      statusEl.textContent = 'Loading…';
      try {
        const url = "{{ url_for('admin.admin_lines_fragment') }}" +
                    "?week=" + encodeURIComponent(w) +
                    "&tz=" + encodeURIComponent(userTZ);
        const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' } });
        const html = await res.text();
        if (!res.ok) throw new Error(html || ('Failed to load week ' + w));
        container.innerHTML = html;
        statusEl.textContent = '';
      } catch (e) {
        statusEl.textContent = 'Failed to load lines.';
        console.error(e);
      }
    }

    weekSel?.addEventListener('change', () => loadAdminLines(weekSel.value));
    if (weekSel) loadAdminLines(weekSel.value);
  })();
  </script>
{% endblock %}
