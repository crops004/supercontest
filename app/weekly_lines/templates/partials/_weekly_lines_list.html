{% set ats_by_game = ats_by_game|default({}) %}
{% set disable = disable_inputs|default(false) %}

{# Colored score badge:
   - pending => neutral badge with the current numeric score if available, else —
   - final   => win/lose/push coloring based on numeric comparison
#}
{% macro score_badge_for(val, other, is_final) -%}
  {% if not is_final %}
    {% if val is not none %}
      <span class="score-badge score-pending" title="In progress">{{ val }}</span>
    {% else %}
      <span class="score-badge score-pending" title="Not started">—</span>
    {% endif %}
  {% elif val > other %}
    <span class="score-badge score-win" title="Winner">{{ val }}</span>
  {% elif val < other %}
    <span class="score-badge score-lose" title="Loser">{{ val }}</span>
  {% else %}
    <span class="score-badge score-push" title="Tie">{{ val }}</span>
  {% endif %}
{%- endmacro %}

{% if groups|length == 0 %}
  <p>No games for this week.</p>
{% else %}
  {% for day_title, times in groups %}
    <h2 style="margin:1rem 0 .25rem; font-weight:700;">{{ day_title }}</h2>

    {% for time_title, items in times %}
      <h3 style="margin:.25rem 0 .25rem; font-weight:600;">{{ time_title }}</h3>

      {% for g in items %}
        {% set locked = (g.kickoff_at and now_utc and g.kickoff_at <= now_utc) %}
        {% set chosen = picks_by_game.get(g.id) %}
        {% set already = (chosen is not none) %}

        {# Final = explicit completed flag if present; else require both final scores #}
        {% set is_final = (g.completed if g.completed is not none else (g.final_score_home is not none and g.final_score_away is not none)) %}

        <div class="game" style="padding:.6rem 0; border-top:1px solid #ddd;">

          <!-- Away (top) -->
          <div class="row" style="display:flex; justify-content:space-between; align-items:center; gap:.5rem;">
            <label style="display:flex; gap:.5rem; align-items:center; flex:1;">
              {% if current_user.is_authenticated and not disable %}
                <input
                  class="pick-box"
                  type="checkbox"
                  name="picks"
                  value="{{ g.id }}|{{ g.away_team }}"
                  data-game="{{ g.id }}"
                  data-already-picked="{{ 1 if chosen == g.away_team else 0 }}"
                  {% if locked %}disabled{% endif %}
                  {% if chosen == g.away_team %}checked{% endif %}
                />
              {% endif %}
              <span class="team">
                {{ g.away_team }}
                {{ score_badge_for(g.final_score_away, g.final_score_home, is_final) }}
              </span>
            </label>
            <div class="line" style="min-width:2.5rem; text-align:right;">
              {% if is_pickem(g) %}
                PK
              {% else %}
                {{ g.spread_away|fmt_spread }}
              {% endif %}
            </div>
          </div>

          <!-- Home (bottom) -->
          <div class="row" style="display:flex; justify-content:space-between; align-items:center; gap:.5rem;">
            <label style="display:flex; gap:.5rem; align-items:center; flex:1;">
              {% if current_user.is_authenticated and not disable %}
                <input
                  class="pick-box"
                  type="checkbox"
                  name="picks"
                  value="{{ g.id }}|{{ g.home_team }}"
                  data-game="{{ g.id }}"
                  data-already-picked="{{ 1 if chosen == g.home_team else 0 }}"
                  {% if locked %}disabled{% endif %}
                  {% if chosen == g.home_team %}checked{% endif %}
                />
              {% endif %}
              <span class="team">
                {{ g.home_team }}
                {{ score_badge_for(g.final_score_home, g.final_score_away, is_final) }}
              </span>
            </label>
            <div class="line" style="min-width:2.5rem; text-align:right;">
              {% if is_pickem(g) %}
                PK
              {% else %}
                {{ g.spread_home|fmt_spread }}
              {% endif %}
            </div>
          </div>

        </div>
      {% endfor %}
    {% endfor %}
  {% endfor %}
{% endif %}
