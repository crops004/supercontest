{% set disable = disable_inputs|default(false) %}
{% set show_spreads = all_locked|default(false) %}

{# ===================== ATS-colored score badge ===================== #}
{# Displays the numeric score but colors by ATS result: 'W'|'L'|'P'|None #}
{% macro score_badge_ats(result, val) -%}
  {% if result == 'W' %}
    <span class="score-badge score-win">{{ (val is not none) and val or '—' }}</span>
  {% elif result == 'L' %}
    <span class="score-badge score-lose">{{ (val is not none) and val or '—' }}</span>
  {% elif result == 'P' %}
    <span class="score-badge score-push">{{ (val is not none) and val or '—' }}</span>
  {% else %}
    <span class="score-badge score-pending">{{ (val is not none) and val or '—' }}</span>
  {% endif %}
{%- endmacro %}

{% if groups|length == 0 %}
  <p class="text-sm text-copy-lighter">No games for this week.</p>
{% else %}
  {% for day_title, times in groups %}
    {# first game's ISO for sticky header M/D decoration #}
    {% set first_block = times|first %}
    {% set first_items = first_block[1] if first_block else [] %}
    {% set first_game  = first_items|first if first_items else None %}
    {% set first_iso   = first_game.kickoff_at.isoformat() if first_game and first_game.kickoff_at else '' %}

    <!-- Day header -->
    <h2 class="font-semibold text-copy-light"
        data-header="day"
        data-title="{{ day_title }}"
        data-date-iso="{{ first_iso }}">{{ day_title }}</h2>

    <!-- Cards grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
      {% for time_title, items in times %}
        {% for g in items %}
          {% set locked = (g.kickoff_at and now_utc and g.kickoff_at <= now_utc) %}
          {% set chosen = picks_by_game.get(g.id) %}

          {# --- spread visibility & pk logic --- #}
          {% set has_spread_actual = (g.spread_home is not none and g.spread_away is not none) %}
          {% set is_pk             = (has_spread_actual and g.spread_home == 0 and g.spread_away == 0) %}
          {# Only show spreads when the ENTIRE WEEK is locked #}
          {% set has_spread        = (has_spread_actual and show_spreads) %}

          {# ATS per side from server (may already be W/L/P). Normalize if needed. #}
          {% set result_away = ats_resolved.get((g.id, 'away')) %}
          {% set result_home = ats_resolved.get((g.id, 'home')) %}
          {% set map = {'COVER':'W','NO_COVER':'L','PUSH':'P','WIN':'W','LOSS':'L','LOSE':'L'} %}
          {% set result_away = map.get((result_away|string).upper(), result_away) %}
          {% set result_home = map.get((result_home|string).upper(), result_home) %}

          <article
            class="group rounded-xl border border-border bg-foreground p-3 shadow-sm hover:shadow transition"
            data-card
            data-game="{{ g.id }}"
            data-locked="{{ 1 if locked else 0 }}"
          >
            <!-- Top row: kickoff time + lock -->
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs text-copy-lighter">{{ time_title }}</div>
              {% if locked %}
                <div class="flex items-center gap-1 text-error" title="Locked">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M17 8h-1V6a4 4 0 10-8 0v2H7a2 2 0 00-2 2v8a2 2 0 002 2h10a2 2 0 002-2v-8a2 2 0 00-2-2zm-6-2a3 3 0 016 0v2h-6V6z"/>
                  </svg>
                  <span class="text-xs font-medium">Locked</span>
                </div>
              {% endif %}
            </div>

            <!-- Teams stack -->
            <div class="space-y-3">

              {# -------------------- AWAY -------------------- #}
              {% set picked_away   = (chosen == g.away_team) %}
              {% set away_disabled = (disable or not has_spread or locked) %}
              <div class="flex items-center justify-between gap-3"
                   data-team-row
                   data-picked="{{ 1 if picked_away else 0 }}">
                <div class="flex items-center gap-2 min-w-0">
                  <div class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center shrink-0">
                    <img
                      class="max-w-full max-h-full object-contain"
                      src="{{ url_for('static', filename='img/teams/' ~ abbr_team(g.away_team)|lower ~ '.svg') }}"
                      alt="{{ g.away_team }} logo"
                      loading="lazy" decoding="async"
                    />
                  </div>
                  <div class="truncate">
                    <div class="truncate font-medium text-copy-light">{{ g.away_team }}</div>
                    <div class="text-xs">
                      {{ score_badge_ats(result_away, g.final_score_away) }}
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="chip spread
                         {{ ( 'win'  if result_away == 'W'
                             else 'loss' if result_away == 'L'
                             else 'push' if result_away == 'P'
                             else 'pending') if picked_away else 'pending' }}
                         {{ 'picked' if picked_away else '' }}
                         {{ 'disabled' if away_disabled else '' }}"
                  role="button"
                  aria-pressed="{{ 'true' if picked_away else 'false' }}"
                  aria-label="Select {{ g.away_team }} spread"
                  data-role="spread-chip"
                  data-game="{{ g.id }}"
                  data-team="{{ g.away_team }}"
                  {% if away_disabled %} data-disabled="1" data-locked-chip="{{ 1 if locked else 0 }}"{% endif %}
                >
                  {% if not has_spread %}<span class="opacity-50">—</span>
                  {% else %}
                    {% if is_pk %}PK{% else %}{{ g.spread_away|fmt_spread }}{% endif %}
                  {% endif %}
                </button>
              </div>

              {# -------------------- HOME -------------------- #}
              {% set picked_home   = (chosen == g.home_team) %}
              {% set home_disabled = (disable or not has_spread or locked) %}
              <div class="flex items-center justify-between gap-3"
                   data-team-row
                   data-picked="{{ 1 if picked_home else 0 }}">
                <div class="flex items-center gap-2 min-w-0">
                  <div class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center shrink-0">
                    <img
                      class="max-w-full max-h-full object-contain"
                      src="{{ url_for('static', filename='img/teams/' ~ abbr_team(g.home_team)|lower ~ '.svg') }}"
                      alt="{{ g.home_team }} logo"
                      loading="lazy" decoding="async"
                    />
                  </div>
                  <div class="truncate">
                    <div class="truncate font-medium text-copy-light">{{ g.home_team }}</div>
                    <div class="text-xs">
                      {{ score_badge_ats(result_home, g.final_score_home) }}
                    </div>
                  </div>
                </div>

                <button
                  type="button"
                  class="chip spread
                         {{ ( 'win'  if result_home == 'W'
                             else 'loss' if result_home == 'L'
                             else 'push' if result_home == 'P'
                             else 'pending') if picked_home else 'pending' }}
                         {{ 'picked' if picked_home else '' }}
                         {{ 'disabled' if home_disabled else '' }}"
                  role="button"
                  aria-pressed="{{ 'true' if picked_home else 'false' }}"
                  aria-label="Select {{ g.home_team }} spread"
                  data-role="spread-chip"
                  data-game="{{ g.id }}"
                  data-team="{{ g.home_team }}"
                  {% if home_disabled %} data-disabled="1" data-locked-chip="{{ 1 if locked else 0 }}"{% endif %}
                >
                  {% if not has_spread %}<span class="opacity-50">—</span>
                  {% else %}
                    {% if is_pk %}PK{% else %}{{ g.spread_home|fmt_spread }}{% endif %}
                  {% endif %}
                </button>
              </div>

            </div>
          </article>
        {% endfor %}
      {% endfor %}
    </div>
  {% endfor %}
{% endif %}
