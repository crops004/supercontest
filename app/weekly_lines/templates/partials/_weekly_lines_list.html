{% set disable = disable_inputs|default(false) %}

{% macro score_badge(final, val, other) -%}
  {% if not final %}
    <span class="inline-block ml-1 px-1.5 rounded text-xs border font-medium bg-gray-100 border-gray-300 text-gray-600" title="In progress">{{ (val is not none) and val or '—' }}</span>
  {% elif val is not none and other is not none %}
    {% if val > other %}
      <span class="inline-block ml-1 px-1.5 rounded text-xs border font-medium bg-green-100 border-green-200 text-green-800" title="Winner">{{ val }}</span>
    {% elif val < other %}
      <span class="inline-block ml-1 px-1.5 rounded text-xs border font-medium bg-red-100 border-red-200 text-red-800" title="Loser">{{ val }}</span>
    {% else %}
      <span class="inline-block ml-1 px-1.5 rounded text-xs border font-medium bg-yellow-100 border-yellow-200 text-yellow-800" title="Tie">{{ val }}</span>
    {% endif %}
  {% else %}
    <span class="inline-block ml-1 px-1.5 rounded text-xs border font-medium bg-gray-100 border-gray-300 text-gray-600">—</span>
  {% endif %}
{%- endmacro %}

{% if groups|length == 0 %}
  <p class="text-sm text-gray-500">No games for this week.</p>
{% else %}
  {% for day_title, times in groups %}
    {% set first_block = times|first %}
    {% set first_items = first_block[1] if first_block else [] %}
    {% set first_game  = first_items|first if first_items else None %}
    {% set first_iso   = first_game.kickoff_at.isoformat() if first_game and first_game.kickoff_at else '' %}

    <!-- Day header -->
    <h2 class="font-bold text-gray-900"
        data-header="day"
        data-title="{{ day_title }}"
        data-date-iso="{{ first_iso }}">{{ day_title }}</h2>

    <!-- Cards grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
      {% for time_title, items in times %}
        {% for g in items %}
          {% set locked   = (g.kickoff_at and now_utc and g.kickoff_at <= now_utc) %}
          {% set chosen   = picks_by_game.get(g.id) %}
          {% set is_final = (g.completed == True) %}
          {% set is_pk    = (g.spread_home is not none and g.spread_away is not none and g.spread_home == 0 and g.spread_away == 0) %}
          {% set has_spreads = (g.spread_home is not none and g.spread_away is not none) %}

          <article
            class="group rounded-xl border border-gray-200 bg-white p-3 shadow-sm hover:shadow transition"
            data-card
            data-game="{{ g.id }}"
            data-locked="{{ 1 if locked else 0 }}"
          >
            <!-- Top row: kickoff time + lock -->
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs text-gray-500">
                {{ time_title }}
              </div>
              {% if locked %}
                <div class="flex items-center gap-1 text-rose-600" title="Locked">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M17 8h-1V6a4 4 0 10-8 0v2H7a2 2 0 00-2 2v8a2 2 0 002 2h10a2 2 0 002-2v-8a2 2 0 00-2-2zm-6-2a3 3 0 016 0v2h-6V6z"/>
                  </svg>
                  <span class="text-xs font-medium">Locked</span>
                </div>
              {% endif %}
            </div>

            <!-- Teams stack -->
            <div class="space-y-3">

              <!-- Away row -->
              <div class="flex items-center justify-between gap-3" data-team-row data-picked="{{ 1 if chosen == g.away_team else 0 }}">
                <div class="flex items-center gap-2 min-w-0">
                  <!-- Away logo -->
                  <div class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center shrink-0">
                    <img
                      class="max-w-full max-h-full object-contain"
                      src="{{ url_for('static', filename='img/teams/' ~ abbr_team(g.away_team)|lower ~ '.svg') }}"
                      alt="{{ g.away_team }} logo"
                      loading="lazy" decoding="async"
                    />
                  </div>
                  <div class="truncate">
                    <div class="truncate font-medium">{{ g.away_team }}</div>
                    <div class="text-xs text-gray-500">
                      {{ score_badge(is_final, g.final_score_away, g.final_score_home) }}
                    </div>
                  </div>
                </div>

                {% set away_disabled = (not has_spreads or locked) %}
                {% set pressed_away = (chosen == g.away_team and not locked) %}
                <button
                  type="button"
                  class="shrink-0 px-3 py-1 rounded-full border text-sm transition
                         focus:outline-none focus:ring
                         {% if away_disabled %} border-gray-200 text-gray-300 cursor-not-allowed {% else %}
                           {% if pressed_away %} border-blue-600 bg-blue-50 text-blue-700 {% else %} border-gray-300 bg-white hover:bg-gray-50 {% endif %}
                         {% endif %}"
                  role="button"
                  aria-pressed="{{ 'true' if pressed_away else 'false' }}"
                  aria-label="Select {{ g.away_team }} spread"
                  data-role="spread-chip"
                  data-game="{{ g.id }}"
                  data-team="{{ g.away_team }}"
                  {% if away_disabled %} data-disabled="1" data-locked-chip="{{ 1 if locked else 0 }}"{% endif %}
                >
                  {% if not has_spreads %}<span class="opacity-50">—</span>
                  {% else %}
                    {% if is_pk %}PK{% else %}{{ g.spread_away|fmt_spread }}{% endif %}
                  {% endif %}
                </button>
              </div>

              <!-- Home row -->
              <div class="flex items-center justify-between gap-3" data-team-row data-picked="{{ 1 if chosen == g.home_team else 0 }}">
                <div class="flex items-center gap-2 min-w-0">
                  <!-- Home logo -->
                  <div class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center shrink-0">
                    <img
                      class="max-w-full max-h-full object-contain"
                      src="{{ url_for('static', filename='img/teams/' ~ abbr_team(g.home_team)|lower ~ '.svg') }}"
                      alt="{{ g.home_team }} logo"
                      loading="lazy" decoding="async"
                    />
                  </div>
                  <div class="truncate">
                    <div class="truncate font-medium">{{ g.home_team }}</div>
                    <div class="text-xs text-gray-500">
                      {{ score_badge(is_final, g.final_score_home, g.final_score_away) }}
                    </div>
                  </div>
                </div>

                {% set home_disabled = (not has_spreads or locked) %}
                {% set pressed_home = (chosen == g.home_team and not locked) %}
                <button
                  type="button"
                  class="shrink-0 px-3 py-1 rounded-full border text-sm transition
                         focus:outline-none focus:ring
                         {% if home_disabled %} border-gray-200 text-gray-300 cursor-not-allowed {% else %}
                           {% if pressed_home %} border-blue-600 bg-blue-50 text-blue-700 {% else %} border-gray-300 bg-white hover:bg-gray-50 {% endif %}
                         {% endif %}"
                  role="button"
                  aria-pressed="{{ 'true' if pressed_home else 'false' }}"
                  aria-label="Select {{ g.home_team }} spread"
                  data-role="spread-chip"
                  data-game="{{ g.id }}"
                  data-team="{{ g.home_team }}"
                  {% if home_disabled %} data-disabled="1" data-locked-chip="{{ 1 if locked else 0 }}"{% endif %}
                >
                  {% if not has_spreads %}<span class="opacity-50">—</span>
                  {% else %}
                    {% if is_pk %}PK{% else %}{{ g.spread_home|fmt_spread }}{% endif %}
                  {% endif %}
                </button>
              </div>

            </div>
          </article>
        {% endfor %}
      {% endfor %}
    </div>
  {% endfor %}
{% endif %}
