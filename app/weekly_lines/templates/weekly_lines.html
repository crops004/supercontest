{% extends "base.html" %}

{% block title %}Weekly Lines{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<div class="max-w-[720px] mx-auto my-6 px-4">
  <h1 class="text-xl font-semibold mb-3">Weekly Lines</h1>

  <div class="mb-4 flex items-center gap-2">
    <button id="prev" class="px-2 py-1 border border-gray-300 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50 disabled:cursor-default" type="button">‹ Prev</button>

    <label for="week" class="text-sm text-gray-700">Week:</label>
    <select id="week" name="week" class="px-2 py-1 border border-gray-300 rounded bg-white text-sm">
      {% for w in weeks %}
        <option value="{{ w }}" {{ 'selected' if w == selected_week else '' }}>{{ w }}</option>
      {% endfor %}
    </select>

    <button id="next" class="px-2 py-1 border border-gray-300 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50 disabled:cursor-default" type="button">Next ›</button>

    <span class="flex-1"></span>

    <span id="status" class="text-sm text-gray-500"></span>
  </div>

  <form id="picks-form" method="post" action="{{ url_for('weekly_lines.submit_picks') }}">
    <input type="hidden" name="week" id="week-hidden" value="{{ selected_week }}">
    <input type="hidden" name="tz" id="tz-hidden" value="{{ tzname or '' }}">

    <div id="games">
      {% include "partials/_weekly_lines_list.html" %}
    </div>

    {% if current_user.is_authenticated %}
      <div class="mt-4 flex items-center gap-3">
        <button class="px-3 py-1.5 border border-gray-300 bg-gray-100 rounded hover:bg-gray-200" type="submit">Submit Picks</button>
        <span id="pick-count" class="text-sm text-gray-500">0/5 selected</span>
      </div>
    {% else %}
      <p class="mt-4 text-sm text-gray-500">Log in to make picks.</p>
    {% endif %}
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  const weekEl    = document.getElementById('week');
  const gamesEl   = document.getElementById('games');
  const statusEl  = document.getElementById('status');
  const prevBtn   = document.getElementById('prev');
  const nextBtn   = document.getElementById('next');
  const countEl   = document.getElementById('pick-count');
  const hiddenWeek= document.getElementById('week-hidden');
  const hiddenTz  = document.getElementById('tz-hidden');
  const formEl    = document.getElementById('picks-form');

  // Robust TZ detection with a fallback
  const detectedTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const userTZ = (typeof detectedTZ === 'string' && detectedTZ.length) ? detectedTZ : 'UTC';

  function getWeekOptions() {
    return Array.from(weekEl.options).map(o => parseInt(o.value, 10)).filter(n => !Number.isNaN(n));
  }
  function updatePagerDisabled() {
    const weeks = getWeekOptions();
    const cur = parseInt(weekEl.value, 10);
    prevBtn && (prevBtn.disabled = cur <= Math.min(...weeks));
    nextBtn && (nextBtn.disabled = cur >= Math.max(...weeks));
  }

  function updateHiddenContext() {
    if (hiddenWeek) hiddenWeek.value = String(weekEl.value);
    if (hiddenTz)   hiddenTz.value   = userTZ;
  }

  function qAll(sel) {
    return Array.from(gamesEl.querySelectorAll(sel));
  }

  function computeFixedPicked() {
    const fixedChecked = qAll('input.pick-box[data-already-picked="1"]:checked');
    const gameIds = new Set(fixedChecked.map(b => b.getAttribute('data-game')));
    return gameIds.size;
  }

  function computeDynamicChecked() {
    const dynChecked = qAll('input.pick-box[data-already-picked="0"]:checked:not(:disabled)');
    const gameIds = new Set(dynChecked.map(b => b.getAttribute('data-game')));
    return gameIds.size;
  }

  function totalSelected() {
    return computeFixedPicked() + computeDynamicChecked();
  }

  function updatePickCountUI() {
    if (!countEl) return;
    const total = totalSelected();
    countEl.textContent = `${Math.min(total, 5)}/5 selected`;
  }

  function attachPickHandlers() {
    const boxes = qAll('input.pick-box[type="checkbox"]');

    function enforceLimits(changed) {
      if (changed && changed.checked) {
        const gameId = changed.getAttribute('data-game');
        boxes.forEach(b => {
          if (b !== changed && b.getAttribute('data-game') === gameId) {
            b.checked = false;
          }
        });
      }

      const fixed = computeFixedPicked();
      const dynamic = computeDynamicChecked();
      const total = fixed + dynamic;

      if (total > 5 && changed && changed.dataset.alreadyPicked === '0') {
        changed.checked = false;
      }

      updatePickCountUI();
    }

    boxes.filter(b => !b.disabled).forEach(b => {
      b.addEventListener('change', () => enforceLimits(b));
    });

    enforceLimits(null);
  }

  async function loadWeek(w) {
    statusEl.textContent = 'Loading…';

    try {
      const url = "{{ url_for('weekly_lines.weekly_lines_fragment') }}" +
                  "?week=" + encodeURIComponent(w) +
                  "&tz=" + encodeURIComponent(userTZ);
      const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' } });
      const body = await res.text();
      if (!res.ok) {
        console.error('Fragment error:', res.status, body);
        statusEl.textContent = 'Failed to load week ' + w + '.';
        // Use Tailwind text classes instead of old .muted
        gamesEl.innerHTML = '<p class="text-sm text-gray-500">Sorry, couldn’t load games.</p>';
        return;
      }
      gamesEl.innerHTML = body;
      history.replaceState(
        null,
        '',
        "{{ url_for('weekly_lines.weekly_lines') }}" +
        "?week=" + encodeURIComponent(w) + "&tz=" + encodeURIComponent(userTZ)
      );
      statusEl.textContent = '';
      updatePagerDisabled();
      updateHiddenContext();
      attachPickHandlers();
      updatePickCountUI();
    } catch (e) {
      statusEl.textContent = 'Failed to load week ' + w;
      console.error(e);
    }
  }

  if (formEl) {
    formEl.addEventListener('submit', (e) => {
      if (totalSelected() > 5) {
        e.preventDefault();
        statusEl.textContent = 'You can only have 5 picks total for the week.';
      }
    });
  }

  weekEl.addEventListener('change', e => loadWeek(e.target.value));
  document.getElementById('prev')?.addEventListener('click', () => {
    const weeks = getWeekOptions();
    const curIdx = weeks.indexOf(parseInt(weekEl.value, 10));
    if (curIdx > 0) {
      weekEl.value = String(weeks[curIdx - 1]);
      loadWeek(weekEl.value);
    }
  });
  document.getElementById('next')?.addEventListener('click', () => {
    const weeks = getWeekOptions();
    const curIdx = weeks.indexOf(parseInt(weekEl.value, 10));
    if (curIdx >= 0 && curIdx < weeks.length - 1) {
      weekEl.value = String(weeks[curIdx + 1]);
      loadWeek(weekEl.value);
    }
  });

  // Initial load init
  updateHiddenContext();
  attachPickHandlers();
  updatePagerDisabled();
  updatePickCountUI();

  const qs = new URLSearchParams(window.location.search);
  if (!qs.has('tz')) {
    setTimeout(() => loadWeek(weekEl.value), 0);
  }
</script>
{% endblock %}
