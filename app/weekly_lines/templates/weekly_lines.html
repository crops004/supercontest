{% extends "base.html" %}

{% block title %}Weekly Lines{% endblock %}

{% block head %}
<style>
  /* Over-limit shake (unchanged) */
  @keyframes pick-shake {
    10%, 90% { transform: translateX(-1px); }
    20%, 80% { transform: translateX(2px); }
    30%, 50%, 70% { transform: translateX(-4px); }
    40%, 60% { transform: translateX(4px); }
  }
  .shake { animation: pick-shake 400ms; }

  /* Week controls sit below: NAV + (optional) PICKS + (optional) BILLING */
  #week-controls {
    position: sticky;
    top: calc(var(--h-nav, 52px) + var(--h-picks, 0px) + var(--h-billing, 0px)) !important;
    z-index: 25; /* nav 40, picks 35, billing 32, week 25 */
  }

  /* Day headers sit below week-controls as you scroll */
  .day-header {
    position: sticky;
    top: calc(var(--h-nav, 52px) + var(--h-picks, 0px) + var(--h-billing, 0px) + var(--h-week, 0px)) !important;
    z-index: 20;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-[1100px] mx-auto mb-6 px-4 text-copy-light">
  <!-- Week Controls: sticky under the navbar -->
  <div id="week-controls"
     class="sticky z-20 bg-background border-b border-border"
     data-selected-week="{{ selected_week }}">
    <div class="flex items-center gap-2 py-2">
      <button id="prev"
        class="px-2 py-1 border border-border bg-background rounded hover:bg-foreground disabled:opacity-50 disabled:cursor-default"
        type="button">‹ Prev</button>

      <label for="week" class="text-sm text-copy-light">Week:</label>
      <select id="week" name="week" class="px-2 py-1 border border-border rounded bg-foreground text-sm text-copy">
        {% for w in weeks %}
        <option value="{{ w }}" {{ 'selected' if w==selected_week else '' }}>{{ w }}</option>
        {% endfor %}
      </select>

      <button id="next"
        class="px-2 py-1 border border-border bg-background rounded hover:bg-foreground disabled:opacity-50 disabled:cursor-default"
        type="button">Next ›</button>

      <span class="flex-1"></span>
      <span id="status" class="text-sm text-copy-lighter"></span>
    </div>
  </div>

  <!-- NEW: dynamic lock notice placeholder + initial flag -->
  <div id="lock-note" class="mb-3 text-sm text-copy-lighter hidden"></div>
  <div id="initial-lock-flag" data-all-locked="{{ 1 if all_locked else 0 }}" class="hidden"></div>

  <div class="relative bg-background">
    <!-- Form wrapper kept for non-JS fallback -->
    <form id="picks-form" method="post" action="{{ url_for('weekly_lines.submit_picks') }}">
      <input type="hidden" name="week" id="week-hidden" value="{{ selected_week }}">
      <input type="hidden" name="tz" id="tz-hidden" value="{{ tzname or '' }}">
      <!-- These are managed dynamically as hidden inputs for fallback -->
      <div id="fallback-hidden-inputs"></div>

      <div id="games">
        {% include "partials/_weekly_lines_list.html" %}
      </div>

      {% if current_user.is_authenticated %}
      <div class="mt-4 text-sm text-copy-lighter hidden">
        You’ll see a Submit button after making changes.
      </div>
      {% else %}
      <p class="mt-4 text-sm text-copy-lighter">Log in to make picks.</p>
      {% endif %}
    </form>
  </div>
</div>

<!-- Floating Submit (hidden until there are unsaved changes) -->
<!-- <button id="float-submit"
  class="hidden fixed bottom-5 right-5 z-[60] px-4 py-2 rounded-md shadow-lg
         bg-primary text-primary-content hover:bg-primary-dark
         focus:outline-none focus:ring-1 focus:ring-primary/40
         pointer-events-auto"
  type="button">
  Submit changes
</button> -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
/* ========================================================================== *
 * Weekly Lines: Client-Side Logic
 * ========================================================================== */

/* ---------- DOM refs ---------- */
const weekEl         = document.getElementById('week');
const gamesEl        = document.getElementById('games');
const statusEl       = document.getElementById('status');
const prevBtn        = document.getElementById('prev');
const nextBtn        = document.getElementById('next');
const hiddenWeek     = document.getElementById('week-hidden');
const hiddenTz       = document.getElementById('tz-hidden');
const formEl         = document.getElementById('picks-form');
const floatBtn       = document.getElementById('float-submit');
const fallbackHidden = document.getElementById('fallback-hidden-inputs');
const navEl          = document.querySelector('nav');
const weekControls   = document.getElementById('week-controls');
const lockNoteEl     = document.getElementById('lock-note');

/* ---------- Timezone ---------- */
const detectedTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
const userTZ = (typeof detectedTZ === 'string' && detectedTZ.length) ? detectedTZ : 'UTC';

/* ---------- Local “dirty” state & cache ---------- */
let dirty = false;
function storageKey(week) { return `pendingPicks:${week}`; }

/* ========================================================================== *
 * Utilities
 * ========================================================================== */

/** Robustly get current week (no Jinja in JS). */
function currentWeek() {
  const v1 = parseInt((weekEl && weekEl.value) || "", 10);
  if (Number.isFinite(v1)) return v1;

  const v2 = parseInt((hiddenWeek && hiddenWeek.value) || "", 10);
  if (Number.isFinite(v2)) return v2;

  const ds = document.getElementById("week-controls")?.dataset;
  const v3 = parseInt((ds && ds.selectedWeek) || "", 10);
  if (Number.isFinite(v3)) return v3;

  return 0;
}

/** Enable/disable pager buttons. */
function getWeekOptions() {
  return Array.from(weekEl.options)
    .map(o => parseInt(o.value, 10))
    .filter(n => !Number.isNaN(n));
}
function updatePagerDisabled() {
  const weeks = getWeekOptions();
  const cur = parseInt(weekEl.value, 10);
  prevBtn && (prevBtn.disabled = cur <= Math.min(...weeks));
  nextBtn && (nextBtn.disabled = cur >= Math.max(...weeks));
}

/** Keep hidden context inputs updated for fallback POST. */
function updateHiddenContext() {
  if (hiddenWeek) hiddenWeek.value = String(weekEl.value);
  if (hiddenTz) hiddenTz.value = userTZ;
}

/** Show/hide floating submit button. */
function setDirty(isDirty) {
  dirty = !!isDirty;
  if (!floatBtn) return;
  if (dirty) {
    floatBtn.classList.remove('hidden');
    floatBtn.classList.add('flex', 'items-center', 'justify-center');
  } else {
    floatBtn.classList.add('hidden');
    floatBtn.classList.remove('flex', 'items-center', 'justify-center');
  }
}

/* ---------- NEW: dynamic lock banner ---------- */
function setLockBanner(allLocked) {
  if (!lockNoteEl) return;
  if (allLocked) {
    lockNoteEl.classList.add('hidden');
    lockNoteEl.textContent = '';
  } else {
    const wk = currentWeek();
    lockNoteEl.textContent = `Spreads for Week ${wk} aren’t locked yet. You can browse the matchups; spreads will appear once they’re locked.`;
    lockNoteEl.classList.remove('hidden');
  }
}

/* ========================================================================== *
 * Selection model (chips)
 * ========================================================================== */

function collectSelectionsFromUI() {
  const chips = gamesEl.querySelectorAll('[data-role="spread-chip"][aria-pressed="true"]');
  const picks = [];
  chips.forEach(ch => {
    if (ch.closest('[data-locked="1"]')) return;
    const gid = ch.getAttribute('data-game');
    const team = ch.getAttribute('data-team');
    if (gid && team) picks.push(`${gid}::${team}`);
  });
  return picks;
}
function syncFallbackHiddenInputs() {
  if (!fallbackHidden) return;
  fallbackHidden.innerHTML = '';
  collectSelectionsFromUI().forEach(val => {
    const [gid, team] = val.split('::');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'picks';
    input.value = `${gid}|${team}`;
    fallbackHidden.appendChild(input);
  });
}
function setChipPressed(chip, pressed) {
  chip.setAttribute('aria-pressed', pressed ? 'true' : 'false');
  chip.classList.toggle('picked', !!pressed);
  const row = chip.closest('[data-team-row]');
  if (row) row.setAttribute('data-picked', pressed ? '1' : '0');
}
function unpressSiblings(chip) {
  const gid = chip.getAttribute('data-game');
  const sibs = gamesEl.querySelectorAll(`[data-role="spread-chip"][data-game="${gid}"]`);
  sibs.forEach(s => { if (s !== chip) setChipPressed(s, false); });
}
function computeAlreadyLockedCount() {
  const savedLocked = gamesEl.querySelectorAll('[data-card][data-locked="1"] [data-team-row][data-picked="1"]');
  const gameSet = new Set();
  savedLocked.forEach(el => gameSet.add(el.closest('[data-card]').getAttribute('data-game')));
  return gameSet.size;
}
function currentSelectedCount() {
  const selected = gamesEl.querySelectorAll('[data-role="spread-chip"][aria-pressed="true"]:not([data-locked-chip="1"])');
  const gameSet = new Set();
  selected.forEach(ch => gameSet.add(ch.getAttribute('data-game')));
  return gameSet.size;
}
function tryToggleChip(chip) {
  if (chip.getAttribute('data-disabled') === '1') return;
  const wasPressed = chip.getAttribute('aria-pressed') === 'true';

  if (wasPressed) {
    setChipPressed(chip, false);
    setDirty(true);
    syncFallbackHiddenInputs();
    cacheSelections();
    return;
  }
  unpressSiblings(chip);

  const lockedExisting = computeAlreadyLockedCount();
  const cap = Math.max(0, 5 - lockedExisting);
  const before = currentSelectedCount();
  if (before >= cap) {
    chip.classList.add('shake');
    setTimeout(() => chip.classList.remove('shake'), 450);
    if (window.renderToasts) {
      window.renderToasts([["warning", "Max of 5 picks per week"]]);
    } else {
      alert("Max of 5 picks per week");
    }
    return;
  }

  setChipPressed(chip, true);
  setDirty(true);
  syncFallbackHiddenInputs();
  cacheSelections();
}

/* ---------- ONE-TIME delegated listeners ---------- */
let chipDelegationBound = false;
function bindChipDelegationOnce() {
  if (chipDelegationBound || !gamesEl) return;
  chipDelegationBound = true;

  gamesEl.addEventListener('click', (e) => {
    const chip = e.target.closest('[data-role="spread-chip"]');
    if (!chip || !gamesEl.contains(chip)) return;
    tryToggleChip(chip);
  });

  gamesEl.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const chip = e.target.closest('[data-role="spread-chip"]');
    if (!chip || !gamesEl.contains(chip)) return;
    e.preventDefault();
    tryToggleChip(chip);
  });
}
function attachChipHandlers() {
  gamesEl.querySelectorAll('[data-role="spread-chip"]').forEach(chip => {
    const pressed = chip.getAttribute('aria-pressed') === 'true';
    setChipPressed(chip, pressed);
  });
}

/* ========================================================================== *
 * Sticky/formatting helpers
 * ========================================================================== */

function applyStickyOffsets() {
  if (typeof window.recalcStickyLayout === 'function') {
    window.recalcStickyLayout();
  }
}
function decorateDayHeaders() {
  const headers = document.querySelectorAll('[data-header="day"]');
  headers.forEach(h => {
    const title = h.getAttribute('data-title') || h.textContent || '';
    const iso = h.getAttribute('data-date-iso') || '';
    const md = formatMDFromISO(iso, userTZ);
    h.textContent = md ? `${title} (${md})` : title;
  });
}
function formatMDFromISO(iso, tz) {
  if (!iso) return '';
  try {
    const d = new Date(iso);
    const mo = new Intl.DateTimeFormat('en-US', { timeZone: tz, month: 'numeric' }).format(d);
    const da = new Intl.DateTimeFormat('en-US', { timeZone: tz, day: 'numeric' }).format(d);
    return `${mo}/${da}`;
  } catch { return ''; }
}

/* ========================================================================== *
 * Fragment loading
 * ========================================================================== */

async function loadWeek(w) {
  statusEl.textContent = 'Loading…';
  try {
    const url = "{{ url_for('weekly_lines.weekly_lines_fragment') }}" +
      "?week=" + encodeURIComponent(w) +
      "&tz=" + encodeURIComponent(userTZ);

    const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' } });
    const body = await res.text();

    if (!res.ok) {
      gamesEl.innerHTML = '<p class="text-sm text-copy-lighter">Sorry, couldn’t load games.</p>';
      statusEl.textContent = 'Failed to load week ' + w + '.';
      return;
    }

    gamesEl.innerHTML = body;

    history.replaceState(null, '', "{{ url_for('weekly_lines.weekly_lines') }}" +
      "?week=" + encodeURIComponent(w) + "&tz=" + encodeURIComponent(userTZ));

    statusEl.textContent = '';
    updatePagerDisabled();
    updateHiddenContext();

    // Normalize after each fragment load
    attachChipHandlers();

    requestAnimationFrame(() => {
      decorateDayHeaders();
      applyStickyOffsets();
    });

    // NEW: pull all_locked flag from the fragment and update notice
    const flagEl = gamesEl.querySelector('#locks-flag');
    const allLocked = flagEl ? (flagEl.dataset.allLocked === '1') : true;
    setLockBanner(allLocked);

    restoreSelectionsFromCache();
    syncFallbackHiddenInputs();
    setDirty(false);
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Failed to load week ' + w;
  }
}

/* ========================================================================== *
 * Local cache
 * ========================================================================== */

function restoreSelectionsFromCache() {
  if (gamesEl.querySelector('[data-role="spread-chip"][aria-pressed="true"]')) return;
  const wk = currentWeek();
  try {
    const raw = localStorage.getItem(storageKey(wk));
    if (!raw) return;
    const picks = JSON.parse(raw);
    const set = new Set(picks);
    gamesEl.querySelectorAll('[data-role="spread-chip"]').forEach(ch => {
      const id = `${ch.getAttribute('data-game')}::${ch.getAttribute('data-team')}`;
      if (set.has(id) && ch.getAttribute('data-locked-chip') !== '1') {
        setChipPressed(ch, true);
        unpressSiblings(ch);
      }
    });
  } catch (_) { }
}
function cacheSelections() {
  const wk = currentWeek();
  localStorage.setItem(storageKey(wk), JSON.stringify(collectSelectionsFromUI()));
}
function clearCacheForWeek(wk) {
  localStorage.removeItem(storageKey(wk));
}

/* ========================================================================== *
 * Footer: "Your picks this week" live renderer
 * ========================================================================== */

function renderFooterPicks(committed, cap = 5) {
  const list = document.getElementById('footer-picks-list');
  if (!list) return;
  const picks = Array.isArray(committed) ? committed.slice(0, cap) : [];
  list.innerHTML = '';
  for (const { abbr, team } of picks) {
    const el = document.createElement('span');
    el.className = 'chip';
    el.textContent = (abbr && abbr.trim()) ? abbr : team;
    list.appendChild(el);
  }
  for (let i = picks.length; i < cap; i++) {
    const ph = document.createElement('span');
    ph.className = 'chip placeholder';
    ph.textContent = '—';
    list.appendChild(ph);
  }
}

/* ========================================================================== *
 * Submit handler (AJAX)
 * ========================================================================== */

floatBtn?.addEventListener('click', async () => {
  const picks = collectSelectionsFromUI();
  const wk = currentWeek();
  statusEl.textContent = 'Saving…';
  floatBtn.disabled = true;

  try {
    const res = await fetch("{{ url_for('weekly_lines.submit_picks_api') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ week: wk, picks })
    });

    let data = {};
    try { data = await res.json(); } catch {}

    if (!res.ok || !data.ok) {
      statusEl.textContent = (data && data.error) ? data.error : `Save failed (${res.status}).`;
      floatBtn.disabled = false;
      return;
    }

    renderFooterPicks(data.committed_picks || []);
    statusEl.textContent = `Saved ${data.saved} pick${data.saved === 1 ? '' : 's'}.`;
    setDirty(false);
    floatBtn.disabled = false;
    clearCacheForWeek(wk);

    // ✅ Update the picks banner instantly
    if (typeof window.refreshPicksBanner === 'function') {
      await window.refreshPicksBanner();
    }

    // Reload the games list (locked states, etc.)
    await loadWeek(wk);

    // Recalc sticky layout just in case heights changed
    if (typeof window.recalcStickyLayout === 'function') {
      window.recalcStickyLayout();
    }
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Save failed.';
    floatBtn.disabled = false;
  }
});

/* ========================================================================== *
 * Init & Events
 * ========================================================================== */

function initAfterRender() {
  updateHiddenContext();
  updatePagerDisabled();

  bindChipDelegationOnce();
  attachChipHandlers();

  requestAnimationFrame(() => {
    decorateDayHeaders();
    applyStickyOffsets();
  });

  // Initial banner state from full-page render
  const initialFlag = document.getElementById('initial-lock-flag');
  const allLocked = initialFlag ? (initialFlag.dataset.allLocked === '1') : true;
  setLockBanner(allLocked);

  restoreSelectionsFromCache();
  syncFallbackHiddenInputs();
  setDirty(false);
}

weekEl.addEventListener('change', e => loadWeek(e.target.value));
document.getElementById('prev')?.addEventListener('click', () => {
  const weeks = getWeekOptions();
  const curIdx = weeks.indexOf(parseInt(weekEl.value, 10));
  if (curIdx > 0) {
    weekEl.value = String(weeks[curIdx - 1]);
    loadWeek(weekEl.value);
  }
});
document.getElementById('next')?.addEventListener('click', () => {
  const weeks = getWeekOptions();
  const curIdx = weeks.indexOf(parseInt(weekEl.value, 10));
  if (curIdx >= 0 && curIdx < weeks.length - 1) {
    weekEl.value = String(weeks[curIdx + 1]);
    loadWeek(weekEl.value);
  }
});

window.addEventListener('resize', () => {
  decorateDayHeaders();
  applyStickyOffsets();
}, { passive: true });

initAfterRender();

const qs = new URLSearchParams(window.location.search);
if (!qs.has('tz')) setTimeout(() => loadWeek(weekEl.value), 0);
</script>
{% endblock %}
