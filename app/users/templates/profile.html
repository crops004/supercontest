{% extends "base.html" %}
{% block title %}Profile{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto p-4 text-copy">
  <header class="mb-6">
    <h1 class="text-3xl font-bold">Your Profile</h1>
    <p class="text-sm text-copy-lighter">Manage account and notifications.</p>
  </header>

  <div class="grid gap-4 md:grid-cols-2 auto-rows-auto">
    <!-- Account (left on desktop) -->
    <section class="bg-foreground border border-border rounded-xl p-4 md:order-1">
      <!-- header -->
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Account</h2>
        <div class="flex gap-2">
          <button id="acct-edit" type="button"
            class="inline-flex items-center justify-center rounded-lg border border-border bg-background hover:bg-foreground px-3 py-1.5 text-sm">
            Edit
          </button>
          <button id="acct-cancel" type="button"
            class="hidden items-center justify-center rounded-lg border border-border bg-background hover:bg-foreground px-3 py-1.5 text-sm">
            Cancel
          </button>
        </div>
      </div>

      <form id="acct-form" method="POST" action="{{ url_for('users.update_account') }}" class="mt-3 space-y-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label for="first_name" class="block text-sm text-copy-lighter mb-1">First name</label>
            <input id="first_name" name="first_name" type="text" value="{{ current_user.first_name or '' }}" disabled
              class="w-full rounded border border-border bg-foreground text-copy px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40">
          </div>
          <div>
            <label for="last_name" class="block text-sm text-copy-lighter mb-1">Last name</label>
            <input id="last_name" name="last_name" type="text" value="{{ current_user.last_name or '' }}" disabled
              class="w-full rounded border border-border bg-foreground text-copy px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40">
          </div>
        </div>

        <div>
          <label for="username" class="block text-sm text-copy-lighter mb-1">Username</label>
          <input id="username" name="username" type="text" required value="{{ current_user.username or '' }}" disabled
            class="w-full rounded border border-border bg-foreground text-copy px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/40">
          <p class="text-xs text-copy-lighter mt-1">3–32 characters. Letters, numbers, dot, underscore, or hyphen.</p>
        </div>

        <div class="pt-1 flex gap-2">
          <button id="acct-save" type="submit"
            class="hidden items-center justify-center rounded-lg bg-primary text-primary-content px-4 py-1.5 text-sm font-semibold hover:bg-primary-dark">
            Save changes
          </button>
          <a href="{{ url_for('auth.change_password') }}"
            class="inline-flex items-center justify-center rounded-lg border border-border bg-background hover:bg-foreground px-3 py-1.5 text-sm">
            Change password
          </a>
        </div>
      </form>
    </section>

    <!-- Notifications (right on desktop) -->
    <section class="bg-foreground border border-border rounded-xl p-4 md:order-2">
      <h2 class="text-xl font-semibold mb-3">Notifications</h2>
      <form method="POST" action="{{ url_for('users.update_notifications') }}" class="grid gap-3 md:grid-cols-2">
        <label class="flex items-start gap-2">
          <input type="checkbox" name="notify_lines_posted" class="mt-1 accent-primary" {{ 'checked' if
            current_user.notify_lines_posted else '' }}>
          <span class="text-sm">Email me when weekly lines are posted</span>
        </label>
        <label class="flex items-start gap-2">
          <input type="checkbox" name="notify_picks_reminder" class="mt-1 accent-primary" {{ 'checked' if
            current_user.notify_picks_reminder else '' }}>
          <span class="text-sm">Reminder before Sunday kickoffs if I have &lt;5 picks</span>
        </label>
        <label class="flex items-start gap-2 md:col-span-2">
          <input type="checkbox" name="notify_weekly_recap" class="mt-1 accent-primary" {{ 'checked' if
            current_user.notify_weekly_recap else '' }}>
          <span class="text-sm">Weekly recap when standings finalize</span>
        </label>
        <div class="md:col-span-2 pt-1">
          <button type="submit"
            class="inline-flex items-center justify-center rounded-lg bg-primary text-primary-content px-4 py-1.5 text-sm font-semibold hover:bg-primary-dark">
            Save notification settings
          </button>
        </div>
      </form>
    </section>

    <!-- Entry Payment (full width row 2) -->
    <section class="bg-foreground border border-border rounded-xl p-4 md:order-3 md:col-span-2">
      <h2 class="text-xl font-semibold mb-3">Entry Payment</h2>
      {% if current_user.entry_paid %}
      <span class="chip win">Paid</span>
      {% else %}
      <div class="flex items-center gap-2">
        <span class="chip loss">Unpaid</span>
        <a href="https://venmo.com/u/Joe-Cropsey" target="_blank" rel="noopener"
          class="inline-flex items-center justify-center rounded-lg bg-primary text-primary-content px-3 py-1.5 text-sm font-semibold hover:bg-primary-dark">
          Pay on Venmo →
        </a>
      </div>
      <p class="text-xs text-copy-lighter mt-1">$52 entry ($2 to site). Unpaid entries eliminated after Week 4.</p>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (function () {
    const form      = document.getElementById('acct-form');
    const inputs    = Array.from(form.querySelectorAll('input'));
    const editBtn   = document.getElementById('acct-edit');
    const saveBtn   = document.getElementById('acct-save');
    const cancelBtn = document.getElementById('acct-cancel');

    const original = Object.fromEntries(inputs.map(i => [i.id, i.value]));

    function show(el){ el.classList.remove('hidden'); el.classList.add('inline-flex'); }
    function hide(el){ el.classList.add('hidden'); el.classList.remove('inline-flex'); }

    function setEditing(on){
      inputs.forEach(i => i.disabled = !on);
      if(on){ hide(editBtn); show(saveBtn); show(cancelBtn); }
      else  { show(editBtn); hide(saveBtn); hide(cancelBtn); }
    }

    editBtn.addEventListener('click', () => setEditing(true));
    cancelBtn.addEventListener('click', () => {
      inputs.forEach(i => i.value = original[i.id] || '');
      setEditing(false);
    });
  })();
</script>
{% endblock %}