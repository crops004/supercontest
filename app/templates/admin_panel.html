{% extends "base.html" %}
{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="mx-auto max-w-[1100px] p-4">
  <h1 class="text-2xl font-bold mb-4">Admin Panel</h1>

  <!-- Core admin actions -->
  <div class="mb-4 flex flex-wrap gap-2">
    <form method="post" action="{{ url_for('admin.admin_import_lines', week=selected_week) }}" class="inline">
      <button class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Import Lines (Pre + Regular)</button>
    </form>

    <form method="post" action="{{ url_for('admin.admin_import_scores', week=selected_week) }}" class="inline">
      <button class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Import Scores (last 3 days)</button>
    </form>

    <form method="post" action="{{ url_for('admin.admin_lock_weeks', week=selected_week) }}" class="inline">
      <button class="px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700">Lock Weeks Through Current</button>
    </form>

    <form method="post" action="{{ url_for('admin.admin_refresh_spreads', week=selected_week) }}" class="inline">
      <button class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Refresh Spreads (Unlocked Only)</button>
    </form>
  </div>

  <!-- Weekly cadence -->
  <div class="mt-2 mb-6 flex flex-wrap gap-2">
    <!-- Tuesday midday -->
    <form action="{{ url_for('admin.admin_prep_week', week=selected_week) }}" method="post" class="inline">
      <button type="submit" class="px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-700">
        Prep Week {{ selected_week }} (Lock + Snapshot Closers)
      </button>
    </form>

    <!-- Thu/Sun/Mon nights -->
    <form action="{{ url_for('admin.admin_scores_and_finalize_week', week=selected_week) }}" method="post" class="inline">
      <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">
        Update Scores + Finalize ATS (Week {{ selected_week }})
      </button>
    </form>
  </div>

  <hr class="my-6 border-slate-200">

  <h2 class="text-xl font-semibold mb-3">Picks Matrix</h2>

  <form method="get" action="{{ url_for('admin.admin_panel') }}" class="mb-4 flex items-center gap-3">
    <label class="flex items-center gap-2">
      <span>Week:</span>
      <select name="week" class="border border-slate-300 rounded px-2 py-1">
        {% for w in weeks %}
          <option value="{{ w }}" {{ 'selected' if w == selected_week else '' }}>{{ w }}</option>
        {% endfor %}
      </select>
    </label>
    <button class="px-3 py-1 rounded border border-slate-300 bg-slate-50 hover:bg-white">Go</button>
  </form>

  <div class="overflow-x-auto rounded-xl border border-slate-200">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-700">
        <tr>
          <th class="px-3 py-2 text-left font-semibold">User</th>
          <th class="px-3 py-2 text-left font-semibold">Pick 1</th>
          <th class="px-3 py-2 text-left font-semibold">Pick 2</th>
          <th class="px-3 py-2 text-left font-semibold">Pick 3</th>
          <th class="px-3 py-2 text-left font-semibold">Pick 4</th>
          <th class="px-3 py-2 text-left font-semibold">Pick 5</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for row in matrix %}
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2 font-medium">{{ row.username }}</td>

          {% for pk in row.picks %}
            <td class="px-3 py-2">
              {% if pk.team %}
                {# Show chip with status color; fallback to placeholder if status not in set #}
                {% if pk.status in ['win','loss','push','pending'] %}
                  <span class="chip {{ pk.status }}" title="{{ pk.team }}">{{ pk.team|team_short }}</span>
                {% elif pk.status == 'empty' %}
                  <span class="chip placeholder">—</span>
                {% else %}
                  <span class="chip pending" title="{{ pk.team }}">{{ pk.team|team_short }}</span>
                {% endif %}
              {% else %}
                <span class="chip placeholder">—</span>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <hr class="my-6 border-slate-200">

  <!-- ATS Summary Controls -->
  <form method="get" action="{{ url_for('admin.admin_panel') }}" class="mb-3 flex flex-wrap items-center gap-4">
    <input type="hidden" name="week" value="{{ selected_week }}">
    <label class="inline-flex items-center gap-2">
      <input type="radio" name="ats_scope" value="season" {{ 'checked' if ats_scope != 'week' else '' }} class="accent-slate-600">
      <span>Season-to-date (≤ Week {{ selected_week }})</span>
    </label>
    <label class="inline-flex items-center gap-2">
      <input type="radio" name="ats_scope" value="week" {{ 'checked' if ats_scope == 'week' else '' }} class="accent-slate-600">
      <span>This week only (Week {{ selected_week }})</span>
    </label>
    <button type="submit" class="px-3 py-1 rounded border border-slate-300 bg-slate-50 hover:bg-white text-sm">Update</button>
  </form>

  <!-- ATS Summary Table -->
  <div class="overflow-x-auto rounded-xl border border-slate-200">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-50 text-slate-700">
        <tr>
          <th class="px-3 py-2 text-left font-semibold">Team</th>
          <th class="px-3 py-2 text-center font-semibold">Covers</th>
          <th class="px-3 py-2 text-center font-semibold">Pushes</th>
          <th class="px-3 py-2 text-center font-semibold">No-Covers</th>
          <th class="px-3 py-2 text-center font-semibold">Record</th>
          <th class="px-3 py-2 text-center font-semibold">Cover %</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for row in ats_summary %}
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2">{{ row.team }}</td>
          <td class="px-3 py-2 text-center">{{ row.covers }}</td>
          <td class="px-3 py-2 text-center">{{ row.pushes }}</td>
          <td class="px-3 py-2 text-center">{{ row.nocovers }}</td>
          <td class="px-3 py-2 text-center">{{ row.record }}</td>
          <td class="px-3 py-2 text-center">{{ '%.1f%%' % row.pct }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="px-3 py-3 text-slate-600">No ATS data yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <hr class="my-6 border-slate-200">

  <h2 class="text-xl font-semibold mb-3">Weekly Lines (Admin Preview)</h2>
  <form id="admin-lines-form" class="mb-4 flex items-center gap-3">
    <label class="flex items-center gap-2">
      <span>Week:</span>
      <select id="admin-lines-week" name="week" class="border border-slate-300 rounded px-2 py-1">
        {% for w in weeks %}
          <option value="{{ w }}" {{ 'selected' if w == selected_week else '' }}>{{ w }}</option>
        {% endfor %}
      </select>
    </label>
    <span id="admin-lines-status" class="text-slate-600 text-sm"></span>
  </form>

  <div id="admin-lines"></div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      const container = document.getElementById('admin-lines');
      const weekSel   = document.getElementById('admin-lines-week');
      const statusEl  = document.getElementById('admin-lines-status');
      const userTZ    = Intl.DateTimeFormat().resolvedOptions().timeZone || '';

      async function loadAdminLines(w) {
        statusEl.textContent = 'Loading…';
        try {
          const url = "{{ url_for('admin.admin_lines_fragment') }}" +
                      "?week=" + encodeURIComponent(w) +
                      "&tz=" + encodeURIComponent(userTZ);
          const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' } });
          const html = await res.text();
          if (!res.ok) throw new Error(html || ('Failed to load week ' + w));
          container.innerHTML = html;
          statusEl.textContent = '';
        } catch (e) {
          statusEl.textContent = 'Failed to load lines.';
          console.error(e);
        }
      }

      weekSel?.addEventListener('change', () => loadAdminLines(weekSel.value));
      if (weekSel) loadAdminLines(weekSel.value);
    })();
  </script>
{% endblock %}
