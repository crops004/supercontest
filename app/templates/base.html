<!DOCTYPE html>
<html lang="en"> <!-- no data-theme by default = LIGHT -->

<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Train+One&display=swap" rel="stylesheet">

  <meta charset="UTF-8">
  <title>{% block title %}Supercontest{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Provide safe defaults so sticky offsets always exist -->
  <style>
    :root {
    --h-nav: 52px;
    --h-picks: 0px;
    --h-billing: 0px;
    --h-week: 0px;
  }
  </style>

  <!-- Apply saved theme BEFORE CSS to avoid flashes -->
  <script>
    (function () {
      try {
        var pref = localStorage.getItem('theme') || 'light'; // default to light
        if (pref === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
        console.log('[theme:init]', pref);
      } catch (e) { console.error('[theme:init:error]', e); }
    })();
  </script>

  <!-- Tailwind build -->
  <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">

  {% block head %}{% endblock %}
</head>

<body class="bg-background text-copy min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav
    class="sticky top-0 z-40 bg-foreground text-copy border-b border-border px-6 py-3 flex justify-between items-center"
    role="navigation" aria-label="Primary">
    <div>
      <a href="{{ url_for('weekly_lines.weekly_lines') }}"
        class="flex items-center gap-2">
        <span class="font-trainone text-secondary text-xl sm:text-2xl leading-none tracking-wide text-shadow-lg text-shadow-primary/80 hover:text-shadow-xl hover:text-shadow-primary">
  Super Contest
</span>
      </a>
    </div>

    {% set ep = request.endpoint or '' %}
    <div class="flex items-center space-x-4">
      <a href="{{ url_for('weekly_lines.weekly_lines') }}"
        class="{{ 'text-copy font-semibold underline underline-offset-4' if ep.startswith('weekly_lines.') else 'text-copy-lighter hover:text-copy-light' }}">
        Lines
      </a>

      <a href="{{ url_for('standings.standings') }}"
        class="{{ 'text-copy font-semibold underline underline-offset-4' if ep.startswith('standings.') else 'text-copy-lighter hover:text-copy-light' }}">
        Standings
      </a>

      <a href="{{ url_for('main.about') }}"
        class="{{ 'text-copy font-semibold underline underline-offset-4' if ep == 'main.about' else 'text-copy-lighter hover:text-copy-light' }}">
        About
      </a>

      <!-- Small theme toggle -->
      <button id="themeToggle" class="flex h-8 w-8 items-center justify-center rounded-full
                     bg-transparent hover:bg-foreground/60
                     ring-1 ring-border/70 hover:ring-border
                     transition-colors" type="button" aria-label="Toggle theme">
        <!-- Sun icon (shown in LIGHT) -->
        <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-copy" fill="currentColor"
          viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.49 14.32l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM12 5a1 1 0 001-1V2h-2v2a1 1 0 001 1zm7 7a7 7 0 11-14 0 7 7 0 0114 0zm-7 9a1 1 0 00-1 1v2h2v-2a1 1 0 00-1-1zM2 13H0v-2h2a1 1 0 001 1 1 1 0 00-1 1zm22-2h-2a1 1 0 00-1-1 1 1 0 001-1h2v2zM4.96 19.04l-1.8 1.79 1.41 1.41 1.8-1.79-1.41-1.41z" />
        </svg>
        <!-- Moon icon (shown in DARK) -->
        <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" class="hidden h-5 w-5 text-copy" fill="currentColor"
          viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>
      </button>
    </div>
  </nav>

 {# ----------------------------- BANNERS ----------------------------- #}
  {% set _pb = picks_banner if picks_banner is defined else {'show': False} %}
  {% set _bb = billing_banner if billing_banner is defined else {'show': False} %}

  {# Picks banner (primary) — always render skeleton; JS toggles visibility #}
  {% set _pb = picks_banner if picks_banner is defined else {'show': False, 'current_week': '', 'remaining': '', 'link': url_for('weekly_lines.weekly_lines')} %}

  <div id="picks-banner"
      class="sticky z-35 bg-primary text-primary-content shadow-md shadow-secondary/10 {{ '' if _pb.show else 'hidden' }}"
      style="top: var(--h-nav);">
    <div class="max-w-[1100px] mx-auto px-4 py-2 text-sm flex items-center justify-between gap-4">
      <div>
        <span class="font-semibold">Picks not finalized for Week
          <span id="picks-banner-week">{{ _pb.current_week or '' }}</span>
        </span>
        <span class="opacity-90"> — <span id="picks-banner-remaining">{{ _pb.remaining or '' }}</span> more to submit.</span>
      </div>
      <a id="picks-banner-link" href="{{ _pb.link or url_for('weekly_lines.weekly_lines') }}" class="underline font-medium">Make picks →</a>
    </div>
  </div>

  {# Billing banner (amber) — always render skeleton; JS toggles visibility #}
  {% set _bb = billing_banner if billing_banner is defined else {'show': False, 'link': url_for('main.index')} %}

  <div id="billing-banner"
        class="sticky z-32 bg-secondary text-warning-content shadow-md shadow-secondary/10 {{ '' if _bb.show else 'hidden' }}"
        style="top: calc(var(--h-nav) + var(--h-picks));">
      <div class="max-w-[1100px] mx-auto px-4 text-sm flex items-center justify-between gap-4"
          id="billing-inner" style="min-height: 0;">
        <div class="font-medium" id="billing-text">
          League fee not received. Please pay before the start of week 5.
        </div>
        <a id="billing-link"
          href="https://venmo.com/u/Joe-Cropsey"
          target="_blank" rel="noopener noreferrer"
          class="underline font-semibold">
          Pay now →
        </a>
      </div>
    </div>
  {# ------------------------------------------------------------------- #}

  <!-- Main content -->
  <main class="min-h-[70vh] pb-16 md:pb-16">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 z-50 border-t border-border bg-foreground backdrop-blur h-16 md:h-16"
    role="contentinfo">
    {% include "partials/footer.html" %}
  </footer>



{% if current_user.is_authenticated %}
  <!-- Chat sidebar handle + drawer -->
  <button id="chat-handle" type="button" aria-controls="chat-drawer" aria-expanded="false"
    class="fixed top-1/2 right-0 z-40 flex items-center gap-2 rounded-l-lg bg-secondary px-3 py-2 text-sm font-semibold text-secondary-content shadow-lg transition hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-secondary/60 transform -translate-y-1/2">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
      <path d="M4 4a2 2 0 012-2h12a2 2 0 012 2v11a2 2 0 01-2 2h-6.586l-3.707 3.707A1 1 0 017 20.293V17H6a2 2 0 01-2-2V4z" />
    </svg>
    <span class="hidden sm:inline">Chat</span>
    <span id="chat-unread-badge" class="absolute -top-2 -left-2 hidden h-5 w-5 items-center justify-center rounded-full bg-error text-[10px] font-semibold text-error-content shadow-md pointer-events-none">0</span>
  </button>

  <div id="chat-drawer" class="fixed inset-y-0 right-0 z-50 flex max-w-full pointer-events-none" data-open="false" aria-hidden="true" data-current-user-id="{{ current_user.get_id() if current_user.is_authenticated else '' }}">
    <div data-chat-backdrop class="hidden flex-1 bg-black/40 opacity-0 transition-opacity duration-200 ease-out"></div>
    <div data-chat-panel class="relative h-full w-screen max-w-[360px] translate-x-full transform transition-transform duration-300 ease-out pointer-events-auto will-change-transform">
      {% include "partials/chat_panel.html" %}
      <button type="button" data-chat-edge class="absolute left-0 top-1/2 z-10 -translate-x-full -translate-y-1/2 rounded-l-lg bg-secondary px-3 py-2 text-xs font-semibold text-secondary-content shadow-md transition hover:bg-secondary-dark focus:outline-none focus:ring-2 focus:ring-secondary/60 close-chat hidden" aria-label="Hide chat">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4">
          <path d="M13.25 17.25a.75.75 0 001.28.53l4.72-4.72a.75.75 0 000-1.06l-4.72-4.72a.75.75 0 00-1.28.53v9.44zm-5.5 1.5a.75.75 0 001.5 0v-12a.75.75 0 00-1.5 0v12z" />
        </svg>
      </button>
    </div>
  </div>
{% endif %}

  {% block scripts %}
  <!-- Toast stack -->
  
    <div id="toast-wrap" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    (function () {
      const API_BASE = '/api/chat';
      const handle = document.getElementById('chat-handle');
      const drawer = document.getElementById('chat-drawer');
      if (!handle || !drawer) return;

      const currentUserId = drawer.dataset.currentUserId || '';
      if (!currentUserId) return;

      const panel = drawer.querySelector('[data-chat-panel]');
      const backdrop = drawer.querySelector('[data-chat-backdrop]');
      const edgeHandle = drawer.querySelector('[data-chat-edge]');
      const closeButtons = drawer.querySelectorAll('.close-chat');
      const form = drawer.querySelector('[data-chat-form]');
      const textarea = form ? form.querySelector('textarea') : null;
      const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
      const messagesWrap = drawer.querySelector('[data-chat-messages]');
      const scrollRegion = drawer.querySelector('[data-chat-scroll]');
      const statusEl = drawer.querySelector('[data-chat-status]');
      const badge = document.getElementById('chat-unread-badge');

      const storageKey = `chat:lastSeen:${currentUserId}`;
      const messageStore = new Map();
      let pollTimer = null;
      let closeTimer = null;
      let isFetching = false;
      let latestMessageId = null;
      let lastSeenMessageId = null;
      let unreadCount = 0;

      try {
        const stored = localStorage.getItem(storageKey);
        if (stored !== null) {
          const parsed = Number(stored);
          if (!Number.isNaN(parsed)) lastSeenMessageId = parsed;
        }
      } catch (error) {
        console.warn('[chat] unable to read lastSeen', error);
      }

      function setStatus(text) {
        if (statusEl) statusEl.textContent = text || '';
      }

      function isOpen() {
        return drawer.dataset.open === 'true';
      }

      function ensureScrollToBottom() {
        if (!scrollRegion) return;
        requestAnimationFrame(() => {
          scrollRegion.scrollTop = scrollRegion.scrollHeight;
        });
      }

      function focusTextarea() {
        if (!textarea) return;
        requestAnimationFrame(() => {
          if (!textarea) return;
          try {
            if (typeof textarea.focus === 'function') {
              try {
                textarea.focus({ preventScroll: true });
              } catch (_) {
                textarea.focus();
              }
            }
            const length = textarea.value ? textarea.value.length : 0;
            if (typeof textarea.setSelectionRange === 'function') {
              textarea.setSelectionRange(length, length);
            }
          } catch (error) {
            console.warn('[chat] focus failed', error);
          }
        });
      }

      function formatRelativeTime(value) {
        if (!value) return '';
        const timestamp = Number(new Date(value));
        if (!Number.isFinite(timestamp)) return '';
        const diffSeconds = Math.max(0, Math.floor((Date.now() - timestamp) / 1000));
        if (diffSeconds < 30) return 'now';
        const units = [
          { label: 'year', seconds: 31557600 },
          { label: 'month', seconds: 2628000 },
          { label: 'week', seconds: 604800 },
          { label: 'day', seconds: 86400 },
          { label: 'hour', seconds: 3600 },
          { label: 'min', seconds: 60 }
        ];
        for (const unit of units) {
          if (diffSeconds >= unit.seconds) {
            const amount = Math.floor(diffSeconds / unit.seconds);
            const label = unit.label === 'min' ? (amount === 1 ? 'min' : 'mins') : `${unit.label}${amount === 1 ? '' : 's'}`;
            return `${amount} ${label} ago`;
          }
        }
        return 'now';
      }

      function saveLastSeen(id) {
        if (!Number.isFinite(id)) return;
        lastSeenMessageId = id;
        try {
          localStorage.setItem(storageKey, String(id));
        } catch (error) {
          console.warn('[chat] unable to persist lastSeen', error);
        }
      }

      function updateBadge() {
        if (!badge) return;
        if (unreadCount > 0 && !isOpen()) {
          badge.textContent = unreadCount > 9 ? '9+' : String(unreadCount);
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }

      function markAllRead() {
        if (!Number.isFinite(latestMessageId)) return;
        saveLastSeen(latestMessageId);
        unreadCount = 0;
        updateBadge();
      }

      function isOwnMessage(message) {
        return message && message.user && String(message.user.id) === String(currentUserId);
      }

      function buildMessageNode(message) {
        const wrapper = document.createElement('article');
        wrapper.className = 'rounded-lg border border-border bg-background/90 px-3 py-2 text-sm';
        wrapper.dataset.chatMessageId = message.id;

        const meta = document.createElement('div');
        meta.className = 'mb-1 flex items-center justify-between text-xs text-copy-light';

        const author = document.createElement('span');
        author.textContent = message && message.user && message.user.display_name ? message.user.display_name : 'Someone';

        const metaRight = document.createElement('div');
        metaRight.className = 'flex items-center gap-2';

        const time = document.createElement('span');
        time.textContent = formatRelativeTime(message ? message.created_at : '');
        metaRight.appendChild(time);

        const edited = document.createElement('span');
        edited.className = 'hidden text-[0.65rem] uppercase tracking-wide text-secondary';
        edited.textContent = 'edited';
        if (message && message.updated_at && message.updated_at !== message.created_at) edited.classList.remove('hidden');
        metaRight.appendChild(edited);

        meta.appendChild(author);
        meta.appendChild(metaRight);

        const body = document.createElement('p');
        body.className = 'whitespace-pre-wrap break-words text-copy';
        body.textContent = message && message.body ? message.body : '';

        const bodyWrap = document.createElement('div');
        bodyWrap.dataset.chatBody = '';
        bodyWrap.appendChild(body);

        wrapper.appendChild(meta);
        wrapper.appendChild(bodyWrap);
        return wrapper;
      }

      function renderMessages(messages) {
        if (!messagesWrap) return;
        messagesWrap.innerHTML = '';

        if (!Array.isArray(messages) || messages.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'rounded-lg border border-dashed border-border px-3 py-4 text-center text-sm text-copy-light';
          empty.textContent = 'No messages yet. Be the first to start the chat!';
          messagesWrap.appendChild(empty);
          unreadCount = 0;
          updateBadge();
          latestMessageId = null;
          return;
        }

        messages.forEach((message) => {
          messageStore.set(message.id, message);
          messagesWrap.appendChild(buildMessageNode(message));
        });
        ensureScrollToBottom();

        latestMessageId = messages[messages.length - 1].id;
        if (lastSeenMessageId === null) {
          unreadCount = messages.filter((message) => !isOwnMessage(message)).length;
        } else {
          unreadCount = messages.filter((message) => message.id > lastSeenMessageId && !isOwnMessage(message)).length;
        }

        if (isOpen()) markAllRead();
        else updateBadge();
      }

      async function fetchMessages(options = {}) {
        if (isFetching) return;
        isFetching = true;
        try {
          const response = await fetch(`${API_BASE}/messages`, { credentials: 'include' });
          if (!response.ok) throw new Error('Unable to load messages');
          const data = await response.json();
          renderMessages(Array.isArray(data.messages) ? data.messages : []);
          if (options.announce) setStatus('Online');
        } catch (error) {
          console.error('[chat] fetch error', error);
          setStatus('Offline');
        } finally {
          isFetching = false;
        }
      }

      async function sendMessage(body) {
        const response = await fetch(`${API_BASE}/messages`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ body })
        });
        if (!response.ok) {
          let detail = 'Unable to send message';
          try {
            const err = await response.json();
            if (err && (err.description || err.error)) detail = err.description || err.error;
          } catch (_) {}
          throw new Error(detail);
        }
        return response.json();
      }

      function startPolling() {
        if (pollTimer) return;
        pollTimer = setInterval(fetchMessages, 10000);
      }

      function stopPolling() {
        if (!pollTimer) return;
        clearInterval(pollTimer);
        pollTimer = null;
      }

      function openDrawer() {
        if (isOpen()) return;
        if (closeTimer) {
          clearTimeout(closeTimer);
          closeTimer = null;
        }
        drawer.dataset.open = 'true';
        drawer.setAttribute('aria-hidden', 'false');
        drawer.classList.remove('pointer-events-none');
        drawer.classList.add('pointer-events-auto');
        handle.setAttribute('aria-expanded', 'true');
        if (edgeHandle) edgeHandle.classList.remove('hidden');
        if (panel) {
          panel.classList.remove('translate-x-full');
          panel.classList.add('translate-x-0');
        }
        if (backdrop) {
          backdrop.classList.remove('hidden');
          requestAnimationFrame(() => backdrop.classList.remove('opacity-0'));
        }
        document.addEventListener('keydown', handleEscape);
        focusTextarea();
        fetchMessages({ announce: true }).then(markAllRead).catch(() => {});
        startPolling();
      }

      function closeDrawer() {
        if (!isOpen()) return;
        drawer.dataset.open = 'false';
        drawer.setAttribute('aria-hidden', 'true');
        handle.setAttribute('aria-expanded', 'false');
        if (edgeHandle) edgeHandle.classList.add('hidden');
        if (panel) {
          panel.classList.add('translate-x-full');
          panel.classList.remove('translate-x-0');
        }
        if (backdrop) {
          backdrop.classList.add('opacity-0');
          const hide = () => backdrop.classList.add('hidden');
          const timer = setTimeout(hide, 220);
          backdrop.addEventListener('transitionend', () => {
            clearTimeout(timer);
            hide();
          }, { once: true });
        }
        document.removeEventListener('keydown', handleEscape);
        closeTimer = setTimeout(() => {
          drawer.classList.add('pointer-events-none');
          drawer.classList.remove('pointer-events-auto');
          closeTimer = null;
        }, 240);
        updateBadge();
      }

      function handleEscape(event) {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeDrawer();
        }
      }

      function toggleDrawer() {
        if (isOpen()) closeDrawer();
        else openDrawer();
      }

      handle.addEventListener('click', (event) => {
        event.preventDefault();
        toggleDrawer();
      });

      handle.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          toggleDrawer();
        }
      });

      if (backdrop) backdrop.addEventListener('click', closeDrawer);
      closeButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          closeDrawer();
        });
      });

      if (form && textarea) {
        setStatus('Online');
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const value = textarea.value ? textarea.value.trim() : '';
          if (!value) {
            setStatus('Enter a message');
            focusTextarea();
            return;
          }
          if (submitBtn) submitBtn.disabled = true;
          setStatus('Sending...');
          try {
            await sendMessage(value);
            textarea.value = '';
            await fetchMessages({ announce: true });
            focusTextarea();
            markAllRead();
            setStatus('Sent');
            setTimeout(() => setStatus('Online'), 1200);
          } catch (error) {
            console.error('[chat] send error', error);
            setStatus(error && error.message ? error.message : 'Unable to send');
          } finally {
            if (submitBtn) submitBtn.disabled = false;
          }
        });

        textarea.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            form.requestSubmit();
          }
        });
      }

      if (badge) badge.classList.add('hidden');
      fetchMessages({ announce: true }).catch(() => {});
      startPolling();
    })();
  </script>





  <script>
    // Account dropdown menu (unchanged)
    (function () {
      const wrap = document.getElementById('acct-wrap');
      const btn = document.getElementById('acct-btn');
      const menu = document.getElementById('acct-menu');
      if (!wrap || !btn || !menu) return;

      let closeTimer = null;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;

      function show() {
        clearTimeout(closeTimer);
        menu.classList.remove('hidden');
        menu.offsetHeight;
        menu.classList.remove('opacity-0', 'scale-95');
        menu.classList.add('opacity-100', 'scale-100');
        btn.setAttribute('aria-expanded', 'true');
      }

      function hide(delay = 120) {
        clearTimeout(closeTimer);
        closeTimer = setTimeout(() => {
          menu.classList.add('opacity-0', 'scale-95');
          menu.classList.remove('opacity-100', 'scale-100');
          setTimeout(() => {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
          }, 140);
        }, delay);
      }

      function toggle(e) {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = menu.classList.contains('hidden') || menu.classList.contains('opacity-0');
        isHidden ? show() : hide(0);
      }

      btn.addEventListener('pointerdown', toggle);
      if (!isCoarse) {
        wrap.addEventListener('mouseenter', show);
        wrap.addEventListener('mouseleave', () => hide(160));
        menu.addEventListener('mouseenter', show);
        menu.addEventListener('mouseleave', () => hide(160));
      }
      menu.addEventListener('click', (e) => {
        const a = e.target.closest('a');
        if (a) hide(0);
      });
      document.addEventListener('pointerdown', (e) => {
        if (!wrap.contains(e.target)) hide(0);
      });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hide(0); });
    })();

    // Theme toggle (adds/removes data-theme="dark")
    (function () {
      function apply(mode) {
        try {
          if (mode === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
          } else {
            document.documentElement.removeAttribute('data-theme'); // back to light
          }
          localStorage.setItem('theme', mode);
          // swap icons if present
          var sun = document.getElementById('iconSun');
          var moon = document.getElementById('iconMoon');
          if (sun && moon) {
            if (mode === 'dark') { sun.classList.add('hidden'); moon.classList.remove('hidden'); }
            else { moon.classList.add('hidden'); sun.classList.remove('hidden'); }
          }
          console.log('[theme:apply]', mode);
        } catch (e) { console.error('[theme:apply:error]', e); }
      }

      // set icons correctly on load
      apply(document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');

      // bind with delegation so we never miss the click
      document.addEventListener('click', function (e) {
        var btn = e.target.closest('#themeToggle');
        if (!btn) return;
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        apply(isDark ? 'light' : 'dark');
      });
    })();

    // --- Picks banner refresher (works with /api/picks/status if present) ---
        (function () {
          // Toggle logs via: localStorage.setItem('pbDebug','1') and reload
          const DBG = () => localStorage.getItem('pbDebug') === '1';
          const log = (...args) => { if (DBG()) console.log('[picks-banner]', ...args); };

          function $(sel) { return document.querySelector(sel); }

          function renderBanner(data) {
            const root = $("#picks-banner");
            const wkEl = $("#picks-banner-week");
            const remEl = $("#picks-banner-remaining");
            if (!root) { log('renderBanner: no root'); return; }

            const beforeHidden = root.classList.contains('hidden');
            if (!data || data.finalized || !data.show) {
              root.classList.add("hidden");
            } else {
              root.classList.remove("hidden");
              if (wkEl) wkEl.textContent = data.current_week ?? "";
              if (remEl) remEl.textContent = data.remaining ?? "";
            }
            const afterHidden = root.classList.contains('hidden');

            log('renderBanner:',
                { data, beforeHidden, afterHidden,
                  text: root.textContent.trim().slice(0,120) });

            if (typeof window.recalcStickyLayout === "function") {
              window.recalcStickyLayout();
            }
          }

          async function fetchJSON(url, init) {
            const t0 = performance.now();
            let res, txt = null, json = null;
            try {
              res = await fetch(url, init);
              const ct = res.headers.get('content-type') || '';
              if (ct.includes('application/json')) {
                json = await res.json();
              } else {
                txt = await res.text();
              }
              const t1 = performance.now();
              log('fetch', { url, status: res.status,
                            contentType: ct, ms: Math.round(t1 - t0),
                            xUser: res.headers.get('X-PB-User'),
                            xRem: res.headers.get('X-PB-Remaining'),
                            xWk: res.headers.get('X-PB-Week') });
              if (!res.ok) {
                log('fetch:not ok body peek →', (json ?? txt)?.toString()?.slice(0,200));
                return null;
              }
              if (json == null) {
                log('fetch:non-JSON body peek →', (txt ?? '').slice(0,200));
                return null;
              }
              return json;
            } catch (e) {
              log('fetch:error', e);
              return null;
            }
          }

          window.refreshPicksBanner = async function () {
            const url = "/api/picks/status" + `?_=${Date.now()}`;
            log('refreshPicksBanner: start', { url });

            const json = await fetchJSON(url, {
              credentials: "same-origin",
              cache: "no-store",
              headers: { "Accept": "application/json", "Cache-Control": "no-cache" }
            });

            if (!json) { log('refreshPicksBanner: no json (likely non-200 or non-JSON)'); return; }
            renderBanner(json);
          };

          // ✅ run on first load
          document.addEventListener("DOMContentLoaded", () => {
            log('DOMContentLoaded → refresh');
            window.refreshPicksBanner();
          });
          // and again when fully loaded
          window.addEventListener("load", () => {
            log('load → refresh');
            window.refreshPicksBanner();
          });

        // --- Billing banner refresher (height scales by week) ---
        (function () {
          function visible(el) { return !!(el && !el.classList.contains('hidden')); }

          async function refreshBillingBanner() {
            const root  = document.getElementById('billing-banner');
            const inner = document.getElementById('billing-inner');
            const link  = document.getElementById('billing-link');
            if (!root || !inner) return;

            try {
              const res = await fetch(`/api/billing/status?_=${Date.now()}`, {
                credentials: 'same-origin',
                cache: 'no-store',
                headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
              });
              if (!res.ok) return;
              const data = await res.json();

              // Show/hide
              if (!data || !data.show) {
                root.classList.add('hidden');
              } else {
                root.classList.remove('hidden');
                if (link && data.link) link.href = data.link;
              }

              // Height scaling: min-height = picksHeight * factor
              // Measure after picks banner has settled
              requestAnimationFrame(() => {
                const picks = document.getElementById('picks-banner');
                const picksH = visible(picks) ? (picks.offsetHeight || 0) : 0;

                // Fallback base height if picks banner not visible yet
                const baseH = picksH || 40; // px
                const factor = Math.max(1, Math.min(4, parseInt(data?.height_factor ?? 1, 10) || 1));

                // Apply min-height to the inner content so the whole banner grows
                inner.style.minHeight = (baseH * factor) + 'px';
                inner.style.paddingTop = inner.style.paddingBottom = '0'; // vertical centering via min-height
                inner.classList.add('py-0'); // neutralize any Tailwind py-* if needed

                // ensure sticky layout vars update
                if (typeof window.recalcStickyLayout === 'function') window.recalcStickyLayout();
              });
            } catch (_) { /* silent */ }
          }

          // Run at the same moments as picks (and also whenever picks change)
          document.addEventListener('DOMContentLoaded', refreshBillingBanner);
          window.addEventListener('load', refreshBillingBanner);
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') refreshBillingBanner();
          });
          window.addEventListener('pageshow', refreshBillingBanner);

          // When picks change, the picks banner may appear/disappear → recompute billing placement/height
          document.addEventListener('picks:changed', refreshBillingBanner);

          // Expose for manual testing
          window.refreshBillingBanner = refreshBillingBanner;
        })();

        // refresh on tab focus / back nav
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            log('visibilitychange:visible → refresh');
            window.refreshPicksBanner();
          }
        });
        window.addEventListener("pageshow", () => {
          log('pageshow → refresh');
          window.refreshPicksBanner();
        });

        // listens for app-level signal that picks changed
        document.addEventListener("picks:changed", () => {
          log('event picks:changed → refresh');
          window.refreshPicksBanner();
        });

        // Quick manual hook you can run in console
        window.pbTestRefresh = () => { log('manual pbTestRefresh'); return window.refreshPicksBanner(); };
      })();

    // Toasts (palette-aware)
    window.renderToasts = (flashes) => {
      if (!flashes || !flashes.length) return;
      const wrap = document.getElementById("toast-wrap");
      flashes.forEach(([cat, msg]) => {
        const el = document.createElement("div");
        const classes =
          cat === "success" ? "bg-success text-success-content" :
            cat === "warning" ? "bg-warning text-warning-content" :
              cat === "error" ? "bg-error text-error-content" :
                "bg-foreground text-copy";
        el.className = `flex items-start gap-2 px-4 py-2 rounded-lg text-sm shadow-lg ${classes} transition-opacity duration-200`;
        el.innerHTML = `
          <span class="leading-5">${msg}</span>
          <button class="ml-2 text-lg leading-none opacity-80 hover:opacity-100" aria-label="Close">&times;</button>
        `;
        wrap.appendChild(el);
        const close = () => { el.style.opacity = 0; setTimeout(() => el.remove(), 200); };
        el.querySelector("button").addEventListener("click", close);
        setTimeout(close, 4200);
      });
    };

    /* Unified sticky layout measurer:
      Sets --h-nav, --h-picks, --h-billing, --h-week and keeps them current. */
    (function () {
      const root    = document.documentElement;
      const nav     = document.querySelector('nav[role="navigation"]');
      const picks   = document.getElementById('picks-banner');
      const billing = document.getElementById('billing-banner');
      // week-controls only exists on Lines page; if not found, it's fine.
      const qWeek   = () => document.getElementById('week-controls');

      function visible(el) { return !!(el && !el.classList.contains('hidden')); }

      function setVars() {
        const week = qWeek();
        const hNav     = nav     ? nav.offsetHeight     || 0 : 0;
        const hPicks   = visible(picks)   ? (picks.offsetHeight   || 0) : 0;
        const hBilling = visible(billing) ? (billing.offsetHeight || 0) : 0;
        const hWeek    = week    ? week.offsetHeight    || 0 : 0;

        root.style.setProperty('--h-nav',     hNav + 'px');
        root.style.setProperty('--h-picks',   hPicks + 'px');
        root.style.setProperty('--h-billing', hBilling + 'px');
        root.style.setProperty('--h-week',    hWeek + 'px');
      }

      // expose for manual calls if needed
      window.recalcStickyLayout = setVars;

      // Initial + lifecycle hooks
      setVars();
      window.addEventListener('resize', setVars);
      window.addEventListener('pageshow', setVars);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') setVars();
      });

      // Observe size changes
      if ('ResizeObserver' in window) {
        if (nav)     new ResizeObserver(setVars).observe(nav);
        if (picks)   new ResizeObserver(setVars).observe(picks);
        if (billing) new ResizeObserver(setVars).observe(billing);
        // week controls can render later (per-page), so observe the container body for it
        new ResizeObserver(setVars).observe(document.body);
      }

      // Observe show/hide via class/style changes on banners
      if ('MutationObserver' in window) {
        if (picks)   new MutationObserver(setVars).observe(picks,   { attributes: true, attributeFilter: ['class', 'style'] });
        if (billing) new MutationObserver(setVars).observe(billing, { attributes: true, attributeFilter: ['class', 'style'] });
        // watch for week-controls insertion/removal
        new MutationObserver(setVars).observe(document.body, { childList: true, subtree: true });
      }

      // Recompute after AJAX banner refresh
      const orig = window.refreshPicksBanner;
      window.refreshPicksBanner = async function () {
        try { if (typeof orig === 'function') await orig(); }
        finally { setVars(); }
      };
    })();
  </script>


  <!-- global flashes -->
  {% set flashes = get_flashed_messages(with_categories=True) %}
  <script id="flashes-data" type="application/json">
    {{ flashes | tojson }}
  </script>
  <script>
    (function () {
      const raw = document.getElementById('flashes-data')?.textContent || '[]';
      const flashes = JSON.parse(raw);
      window.renderToasts(flashes);
    })();
  </script>
  {% endblock %}
</body>

</html>
