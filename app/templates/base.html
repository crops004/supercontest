<!DOCTYPE html>
<html lang="en"> <!-- no data-theme by default = LIGHT -->

<head>
  <meta charset="UTF-8">
  <title>{% block title %}Supercontest{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Apply saved theme BEFORE CSS to avoid flashes -->
  <script>
    (function () {
      try {
        var pref = localStorage.getItem('theme') || 'light'; // default to light
        if (pref === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
        console.log('[theme:init]', pref);
      } catch (e) { console.error('[theme:init:error]', e); }
    })();
  </script>

  <!-- Tailwind build -->
  <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">

  {% block head %}{% endblock %}
</head>

<body class="bg-background text-copy min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav
    class="sticky top-0 z-40 bg-foreground text-copy border-b border-border px-6 py-3 flex justify-between items-center"
    role="navigation" aria-label="Primary">
    <div>
      <a href="{{ url_for('main.index') }}" class="font-bold hover:text-copy-light">üèà</a>
    </div>

    {% set ep = request.endpoint or '' %}
    <div class="flex items-center space-x-4">
      <a href="{{ url_for('weekly_lines.weekly_lines') }}"
        class="{{ 'text-copy font-semibold underline underline-offset-4' if ep.startswith('weekly_lines.') else 'text-copy-lighter hover:text-copy-light' }}">
        Lines
      </a>

      <a href="{{ url_for('standings.standings') }}"
        class="{{ 'text-copy font-semibold underline underline-offset-4' if ep.startswith('standings.') else 'text-copy-lighter hover:text-copy-light' }}">
        Standings
      </a>

      <a href="{{ url_for('main.about') }}"
        class="{{ 'text-copy font-semibold underline underline-offset-4' if ep == 'main.about' else 'text-copy-lighter hover:text-copy-light' }}">
        About
      </a>

      <!-- Small theme toggle -->
      <button id="themeToggle" class="flex h-8 w-8 items-center justify-center rounded-full
                     bg-transparent hover:bg-foreground/60
                     ring-1 ring-border/70 hover:ring-border
                     transition-colors" type="button" aria-label="Toggle theme">
        <!-- Sun icon (shown in LIGHT) -->
        <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-copy" fill="currentColor"
          viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.49 14.32l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM12 5a1 1 0 001-1V2h-2v2a1 1 0 001 1zm7 7a7 7 0 11-14 0 7 7 0 0114 0zm-7 9a1 1 0 00-1 1v2h2v-2a1 1 0 00-1-1zM2 13H0v-2h2a1 1 0 001 1 1 1 0 00-1 1zm22-2h-2a1 1 0 00-1-1 1 1 0 001-1h2v2zM4.96 19.04l-1.8 1.79 1.41 1.41 1.8-1.79-1.41-1.41z" />
        </svg>
        <!-- Moon icon (shown in DARK) -->
        <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" class="hidden h-5 w-5 text-copy" fill="currentColor"
          viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>
      </button>
    </div>
  </nav>

  <!-- Main content -->
  <main class="min-h-[70vh] pb-16 md:pb-16">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="fixed bottom-0 left-0 right-0 z-50 border-t border-border bg-foreground backdrop-blur h-16 md:h-16"
    role="contentinfo">
    {% include "partials/footer.html" %}
  </footer>

  {% block scripts %}
  <!-- Toast stack -->
  <div id="toast-wrap" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Account dropdown menu (unchanged)
    (function () {
      const wrap = document.getElementById('acct-wrap');
      const btn = document.getElementById('acct-btn');
      const menu = document.getElementById('acct-menu');
      if (!wrap || !btn || !menu) return;

      let closeTimer = null;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;

      function show() {
        clearTimeout(closeTimer);
        menu.classList.remove('hidden');
        menu.offsetHeight;
        menu.classList.remove('opacity-0', 'scale-95');
        menu.classList.add('opacity-100', 'scale-100');
        btn.setAttribute('aria-expanded', 'true');
      }

      function hide(delay = 120) {
        clearTimeout(closeTimer);
        closeTimer = setTimeout(() => {
          menu.classList.add('opacity-0', 'scale-95');
          menu.classList.remove('opacity-100', 'scale-100');
          setTimeout(() => {
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
          }, 140);
        }, delay);
      }

      function toggle(e) {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = menu.classList.contains('hidden') || menu.classList.contains('opacity-0');
        isHidden ? show() : hide(0);
      }

      btn.addEventListener('pointerdown', toggle);
      if (!isCoarse) {
        wrap.addEventListener('mouseenter', show);
        wrap.addEventListener('mouseleave', () => hide(160));
        menu.addEventListener('mouseenter', show);
        menu.addEventListener('mouseleave', () => hide(160));
      }
      menu.addEventListener('click', (e) => {
        const a = e.target.closest('a');
        if (a) hide(0);
      });
      document.addEventListener('pointerdown', (e) => {
        if (!wrap.contains(e.target)) hide(0);
      });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hide(0); });
    })();

    // Theme toggle (adds/removes data-theme="dark")
    (function () {
      function apply(mode) {
        try {
          if (mode === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
          } else {
            document.documentElement.removeAttribute('data-theme'); // back to light
          }
          localStorage.setItem('theme', mode);
          // swap icons if present
          var sun = document.getElementById('iconSun');
          var moon = document.getElementById('iconMoon');
          if (sun && moon) {
            if (mode === 'dark') { sun.classList.add('hidden'); moon.classList.remove('hidden'); }
            else { moon.classList.add('hidden'); sun.classList.remove('hidden'); }
          }
          console.log('[theme:apply]', mode);
        } catch (e) { console.error('[theme:apply:error]', e); }
      }

      // set icons correctly on load
      apply(document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light');

      // bind with delegation so we never miss the click
      document.addEventListener('click', function (e) {
        var btn = e.target.closest('#themeToggle');
        if (!btn) return;
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        apply(isDark ? 'light' : 'dark');
      });
    })();

    // Toasts (palette-aware)
    window.renderToasts = (flashes) => {
      if (!flashes || !flashes.length) return;
      const wrap = document.getElementById("toast-wrap");
      flashes.forEach(([cat, msg]) => {
        const el = document.createElement("div");
        const classes =
          cat === "success" ? "bg-success text-success-content" :
            cat === "warning" ? "bg-warning text-warning-content" :
              cat === "error" ? "bg-error text-error-content" :
                "bg-foreground text-copy";
        el.className = `flex items-start gap-2 px-4 py-2 rounded-lg text-sm shadow-lg ${classes} transition-opacity duration-200`;
        el.innerHTML = `
          <span class="leading-5">${msg}</span>
          <button class="ml-2 text-lg leading-none opacity-80 hover:opacity-100" aria-label="Close">&times;</button>
        `;
        wrap.appendChild(el);
        const close = () => { el.style.opacity = 0; setTimeout(() => el.remove(), 200); };
        el.querySelector("button").addEventListener("click", close);
        setTimeout(close, 4200);
      });
    };
  </script>

  <!-- global flashes -->
  {% set flashes = get_flashed_messages(with_categories=True) %}
  <script id="flashes-data" type="application/json">
    {{ flashes | tojson }}
  </script>
  <script>
    (function () {
      const raw = document.getElementById('flashes-data')?.textContent || '[]';
      const flashes = JSON.parse(raw);
      window.renderToasts(flashes);
    })();
  </script>
  {% endblock %}
</body>

</html>